# Build configuration
ARG MEDIAWIKI_IMAGE_URL
ARG COMPOSER_IMAGE_URL

# ###########################################################################
# hadolint ignore=DL3006
FROM ${COMPOSER_IMAGE_URL} as git-checkout
ARG WIKIBASE_COMMIT
RUN git clone https://gerrit.wikimedia.org/r/mediawiki/extensions/Wikibase /tmp/wikibase && \
    git -C /tmp/wikibase checkout ${WIKIBASE_COMMIT} && \
    git -C /tmp/wikibase submodule update --init --recursive && \
    rm -f /tmp/wikibase/.travis.yml && \
    find /tmp/wikibase -name ".git*" -exec rm -rf {} +

# ###########################################################################
# hadolint ignore=DL3006
FROM ${MEDIAWIKI_IMAGE_URL} as collector
COPY --from=git-checkout /tmp/wikibase /var/www/html/extensions/Wikibase

# ###########################################################################
# hadolint ignore=DL3006
FROM ${COMPOSER_IMAGE_URL} as composer
COPY --from=collector --chown=nobody:nogroup /var/www/html /var/www/html
WORKDIR /var/www/html/
COPY composer.local.json /var/www/html/composer.local.json
RUN composer install --verbose -n --no-dev \
    --ignore-platform-req=ext-calendar \
    --ignore-platform-req=ext-intl

# ###########################################################################
# hadolint ignore=DL3006
FROM ${MEDIAWIKI_IMAGE_URL}
ARG GIT_CURRENT_REVISION
LABEL org.opencontainers.image.source="https://github.com/wmde/wikibase-release-pipeline"
# Set error_reporting PHP.ini settings
# This is needed with PHP8+ and MediaWiki 1.39, as Wikibase contains deprecated code
# TODO: remove this and see how far we get
RUN { \
    echo 'error_reporting = E_ALL ^ E_DEPRECATED'; \
} > /usr/local/etc/php/conf.d/error_reporting.ini

RUN apt-get update && \
    DEBIAN_FRONTEND=noninteractive \
    apt-get install --yes --no-install-recommends libbz2-dev=1.* gettext-base && \
    rm -rf /var/lib/apt/lists/* && \
    \
    a2enmod rewrite && \
    install -d /var/log/mediawiki -o www-data && \
    docker-php-ext-install calendar bz2

COPY --from=composer --chown=nobody:nogroup /var/www/html /var/www/html

# Make upload path writable for the webserver user
RUN chown www-data /var/www/html/images -R

COPY entrypoint.sh /entrypoint.sh
COPY jobrunner-entrypoint.sh /jobrunner-entrypoint.sh
COPY htaccess /var/www/html/.htaccess
COPY LocalSettings.* /var/www/html

RUN ln -s /var/www/html/ /var/www/html/w

# MediaWiki build time configuration
ARG MW_WG_SITENAME
ARG MW_WG_LANGUAGE_CODE

ENV DB_NAME=my_wiki\
    MW_WG_SITENAME=${MW_WG_SITENAME}\
    MW_WG_LANGUAGE_CODE=${MW_WG_LANGUAGE_CODE}

ENTRYPOINT ["/bin/bash"]
CMD ["/entrypoint.sh"]
