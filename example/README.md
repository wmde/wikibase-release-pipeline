# Wikibase Suite

Wikibase Suite (WBS) is a containerised, production ready [Wikibase](https://wikiba.se) system, that allows you to self host a knowledge graph similar to Wikidata.

> üí° This document assumes basic Linux administration and docker/docker-compose knowledge.

> üîß This document is for people wanting to self host the full Wikibase Suite using the Wikibase Suite Deployment Kit. If you are looking for individual WBS Service Containers, head over to https://hub.docker.com/u/wikibase

## What is in the box?

This WBS Deployment Kit uses the following WBS Service Containers, all of them packaged as Docker Images:

- **[Wikibase](https://hub.docker.com/r/wikibase/wikibase)** MediaWiki packaged with the Wikibase extension and other commonly used extensions.
- **Job Runner** The MediaWiki [JobRunner](https://www.mediawiki.org/wiki/Manual:Job_queue#Cron) service which uses the same Wikibase container as above.
- **[MariaDB](https://hub.docker.com/_/mariadb)** Database service for MediaWiki and Wikibase.
- **[Elasticsearch](https://hub.docker.com/r/wikibase/elasticsearch)** Search service used by MediaWiki.
- **[WDQS](https://hub.docker.com/r/wikibase/wdqs)** Wikidata Query Service allowing SPARQL queries.
- **[WDQS Frontend](https://hub.docker.com/r/wikibase/wdqs-frontend)** Web Frontend to run SPARQL queries.
- **[wdqs-proxy](https://hub.docker.com/r/wikibase/wdqs-proxy)** A middle layer for WDQS which serves to filter requests and make the service more secure.
- **[WDQS Updater](https://www.mediawiki.org/wiki/Wikidata_Query_Service/User_Manual#runUpdate.sh)** Keeps the WDQS data in sync with Wikibase.
- **[Quickstatements](https://hub.docker.com/r/wikibase/quickstatements)** A web based tool to import and manipulate large amounts of data.
- **[Traefik](https://hub.docker.com/_/traefik)** A reverse proxy handling TLS termination and ACME certificate renewal.

## Quickstart

### Requirements

#### Hardware

- Network connection with a public IP address
- AMD64 architecture
- 8 GB RAM
- 4 GB free disk space
- Docker 22.0, or greater
- Docker Compose 2.10, or greater

#### Domain Names

You need three DNS records that resolve to your machines IP address.

- Wikibase e.g. "wikibase.mydomain.net"
- QueryService e.g. "query.mydomain.net"
- QuickStatements e.g. "quickstatements.mydomain.net"

> üí° If you want to run a quick test on a machine that has no public IP address, check our [FAQ item below](#can-i-host-wikibase-suite-locally?).

### Initial Setup

#### Download the WBS Deployment Kit

Checkout the files from Github. And move to the subdirectory `example`.

```sh
git clone https://github.com/wmde/wikibase-release-pipeline
# TODO update to the correct TAG/BRANCH
git checkout wmde.20
cd wikibase-release-pipeline/example
```

#### Initial Configuration

Make a copy of the [configuration template](./template.env) in `wikibase-release-pipeline/example`

```sh
cp template.env .env
```

Set usernames, passwords and domain names in your newly created `.env` file
according to the instructions in the comments.

#### Starting

Run the following command from within `wikibase-release-pipeline/example`

```sh
docker compose up --wait
```

The first start can take a couple of minutes. Wait for your shell prompt to return.

üéâ Congratulations, your Wikibase Suite instance should be up and running. Web
interfaces are available via HTTPS (port 443) on the domain names you
configured for Wikibase, WDQS Frontend and Quickstatements.

#### Stopping

To stop, use 

```sh
docker compose down
```

#### Resetting the Configuration

Most values set in `.env` are copied statically into the respective containers
after the first time you run `docker compose up`.

To reset the configuration but keep your existing data:

1. Make any needed changes to the values in the `.env` file copied from
   `template.env` above. NOTE: Do not change `DB_*` values unless you are also
   re-creating the database ([see below](#removing-wikibase-suite-completely-with-all-its-data).
2. Delete your LocalSettings.php from the ./config directory.
3. Remove and re-create containers with:

```sh
docker compose down
docker compose up --wait
```

### Advanced Configuration
On first launch, WBS Deployment Kit will create files in the `./config` directory next to your `.env` file and the `docker-compose.yml` and `template.env`. This is the configuration of your instance. You own those files. Backup them in order to create an instance with the same configuration later.

Two of those files are related to MediaWiki itself.

#### config/LocalSettings.php
This file is generated by the [MediaWiki installer script](https://www.mediawiki.org/wiki/Manual:Install.php) and augmented by the Wikibase containers `entrypoint.sh` on first launch. Once this file has been generated, you own it. This means you can make changes, you even might need to make changes on major version updates. In order to ease keeping track of your own adjustments vs settings generated by the Wikibase container, we provide a file called `LocalSettings.override.php`. This file is the preferred location for your adjustments. See below.

The absence of this file is the trigger for the Wikibase container to run the
[MediaWiki installer
script](https://www.mediawiki.org/wiki/Manual:Install.php). So if you need to
run the installer again, just remove the generated `LocalSettings.php` file and
restart your instance.

#### config/LocalSettings.override.php
This file is the location for your MediaWiki and Wikibase customizations. If
you need to regenerate your `LocalSettings.php`, your
`LocalSettings.override.php` is the safe place that is never rewritten, even
when running the [MediaWiki installer
script](https://www.mediawiki.org/wiki/Manual:Install.php).

#### config/wikibase-php.ini
This file is a `php.ini` override file, a good place to tune PHP configuration
values. It will be loaded by the Wikibase Webservers PHP interpreter.

#### docker-compose.yml
To further customize your instance, consider adjusting `docker-compose.yml`. In order to ease updating to newer versions of the WBS Deployment Kit, consider putting your customization into a new file called `docker-compose.override.yml` and restart your instance with

```sh
docker compose -f docker-compose.yml -f docker-compose.override.yml down
docker compose -f docker-compose.yml -f docker-compose.override.yml up --wait
```

This way your changes are kept separate.

### Managing your Data
Besides [your configuration](#configuring-your-wikibase-suite), your data is obviously what makes your instance unique. All data is stored in [Docker Volumes](https://docs.docker.com/storage/volumes/).

 - `wikibase-image-data` MediaWiki image and media file uploads.
 - `mysql-data` MediaWiki/Wikibase MariaDB raw database.
 - `wdqs-data` Wikidata Query Service raw database.
 - `elasticsearch-data` Elastic Search raw database.
 - `quickstatements-data` Quickstatement OAuth binding for this MediaWiki instance.
 - `traefik-letsencrypt-data` SSL cerificates.

#### Backup your Data
You can backup your data by shutting down the stack and dumping the contents of all Docker Volumes into `tar.gz` files.

```sh
docker compose down

for v in \
    wikibase-suite-wikibase_image-data \
    wikibase-suite_mysql-data \
    wikibase-suite_wdqs-data \
    wikibase-suite_elasticsearch-data \
    wikibase-suite_quickstatements-data \
    wikibase-suite_traefik-letsencrypt-data; do
  docker run --rm --volume $v:/backup debian:12-slim tar cz backup > $v.tar.gz
done
```

#### Restore from a backup

To restore a backup, shut down your stack (in case it is already running) and populate the Docker Volumes with data from your `tar.gz` files.

```sh
docker compose down

for v in \
    wikibase-suite-wikibase_image-data \
    wikibase-suite_mysql-data \
    wikibase-suite_wdqs-data \
    wikibase-suite_elasticsearch-data \
    wikibase-suite_quickstatements-data \
    wikibase-suite_traefik-letsencrypt-data; do
  docker volume rm $v 2> /dev/null
  docker volume create $v
  docker run -i --rm --volume $v:/backup debian:12-slim tar xz < $v.tar.gz
done
```

### Updating

WBS is versioned with [Semantic Versioning](https://semver.org/spec/v2.0.0.html). The WBS Deployment Kit and all the WBS Service Containers have individual version numbers.

> üí° WBS Deployment Kit always references the latest minor and patch releases of the compatible WBS Service Containers major versions.

#### Minor updates for WBS Service Containers

As WBS Deployment Kit always references latest minor and patch releases of WBS Service Containers, non breaking changes including security updates are applied automatically when recreating Docker containers. This should be always safe to do. Simply run

```sh
docker compose down 
docker compose up --wait
```

> üí° If you do not want to pull in new versions of WBS Service Containers on restart, just stop your containers before restart without removing them using `docker compose stop`. Please note that this will not apply any security updates. It is generally recommended to remove your containers for restart as described above.

#### Minor updates for WBS Deployment Kit

The WBS Deployment Kit itself receives updates too. If you did not change `docker-compose.yml`, you can update simply using `git`.

```sh
# TODO check BRANCH/TAG before release
git pull
```

> üí° If you did change `docker-compose.yml`, consider using git branches and merging to combine your adjustments with upstream changes.

#### Major upgrades

Major version upgrades are performed by updating WBS Deployment Kit. This might reference compatible new major versions of WBS Service Containers too.

> ‚ÄºÔ∏è Always [create a backup](#backup-your-data) of your data before performing a major version update.

> ‚ÄºÔ∏è Major releases may require additional steps. Refer to specific upgrade instructions in the [Migration Guide](#migration-guide) section below.

Once all version specific migration activities are done, use `git` to update your WBS Deployment Kit to the new version.

```sh
docker compose down 
git remote update
git checkout NEWVERSIONBRANCH
git pull
docker compose up --wait
```

### Removing Wikibase Suite Completely with all its Data

‚ÄºÔ∏è **This will destroy all data, make sure to [backup anything](#backup-your-data) you wish to retain.**

To reset the configuration and data, and remove the WBS Service Containers and Docker Volumes.

```sh
# TODO: test the flow, do we need to delete LocalSettings.php too? What was the DB error wikibase had?
docker compose down --volumes
```

## Migration Guide

When moving from one major version to another, it might be required to perform additional steps for any of the WBS Service Containers. This might include data migration and configuration adjustments.

### Wikibase Suite 24 to 25 (MediaWiki 1.41 to MediaWiki 1.42)

Upgrading Wikibase Suite from Version 24 to Version 25 also upgrades MediaWiki from 1.41 to 1.42. Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_42/UPGRADE).

### Wikibase Suite 23 to 24 (MediaWiki 1.40 to MediaWiki 1.41)

Upgrading Wikibase Suite from Version 23 to Version 24 also upgrades MediaWiki from 1.40 to 1.41. Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_41/UPGRADE).

### Wikibase Suite 22 to 23 (MediaWiki 1.39 to MediaWiki 1.40)

Upgrading Wikibase Suite from Version 22 to Version 23 also upgrades MediaWiki from 1.39 to 1.40. Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_40/UPGRADE).

### From an existing Wikibase installation to Wikibase Suite

It is possible to migrate an existing Wikibase installation to Wikibase Suite. The general procedure would be:

 - [Backup your MediaWiki](https://www.mediawiki.org/wiki/Manual:Backing_up_a_wiki)
 - Install Wikibase Suite as [described above](#initial-setup)
 - Re-apply [customization](#customizing-your-wikibase-suite-mediawiki) to LocalSettings.php
 - Import your database dump
 - Regenerate WDQS database

## FAQ

### Can I host Wikibase Suite locally?

Yes, Wikibase Suite can be hosted locally for testing purposes by using e.g. the example domain names `*.mydomain.net` from `template.env` in your `.env` file. Configure those domain names also in your `/etc/hosts` to make them resolve to `127.0.0.1`.

However, due to OAuth requirements, QuickStatements may not function properly without a publicly accessible domain names for both the `WIKIBASE_PUBLIC_HOST` and `QUICKSTATEMENTS_PUBLIC_HOST`. Running locally without publicly accessible addresses will also not generate a valid SSL certificate so accessing services will require allowing the invalid certificate on first load in the browser. 

### Do you have any recommended Internet host / VPS provider recommendations?

At this time, there are no specific recommendations for Internet hosts or VPS providers for hosting Wikibase Suite. The suite has been tested on various providers, and as long as the minimum technical requirements are met, it should run as expected.

The provided files are for configuring and deploying Wikibase Suite using Docker containers. Wikibase is an extension for MediaWiki that enables the creation and management of structured data, similar to Wikidata. In addition to this configuration of MediaWiki, Wikibase suite includes the Wikidata Query Service (WDQS), QuickStatements, Elasticsearch, and a reverse proxy with SSL services. The configuration is managed through Docker Compose and environment variables.
