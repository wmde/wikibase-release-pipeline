name: "build"
description: "Build"
inputs:
  component:
    description: "name of the component to build"
    required: true
  github_token:
    description: "token to access GHCR"
    required: true

runs:
  using: "composite"

  steps:
    - name: Build
      shell: bash
      run: ./build.sh --save-image ${{ inputs.component }}

    - name: Scan Image
      uses: ./.github/actions/scan-image
      continue-on-error: true
      with:
        image_name: ${{ inputs.component }}

    # TODO: remove extra step with https://phabricator.wikimedia.org/T347000
    - name: Scan additional bundle Image for wikibase builds
      if: inputs.component == 'wikibase'
      uses: ./.github/actions/scan-image
      continue-on-error: true
      with:
        image_name: "${{ inputs.component }}-bundle"

    - uses: ./.github/actions/push-ghcr
      with:
        docker_image: "wikibase/${{ inputs.component }}"
        github_token: ${{ inputs.github_token }}

    # TODO: remove extra step with https://phabricator.wikimedia.org/T347000
    - uses: ./.github/actions/push-ghcr
      if: inputs.component == 'wikibase'
      with:
        docker_image: "wikibase/${{ inputs.component }}-bundle"
        github_token: ${{ inputs.github_token }}
