# Wikibase override for testing client-repo setups
version: '3'

x-common-variables: &wikibase_extra_variables
  MW_ELASTIC_HOST: ${MW_ELASTIC_HOST}
  MW_ELASTIC_PORT: ${MW_ELASTIC_PORT}

services:

  wikibase-selenium-test:
    build:
      context: ../test
      dockerfile: Dockerfile
    volumes:
      - ./suite-config/elasticsearch/setup.sh:/usr/src/app/setup.sh
    environment: 
      <<: *wikibase_extra_variables

  wikibase:
    environment: 
      <<: *wikibase_extra_variables
    volumes:
      - ./suite-config/elasticsearch/wikibase-extra-install.sh:/extra-install.sh

  wikibase-jobrunner:
    environment:
      <<: *wikibase_extra_variables

  elasticsearch:
    image: "${ELASTICSEARCH_IMAGE_NAME}"
    restart: unless-stopped
    networks:
      default:
        aliases:
         - elasticsearch.svc
    environment:
      discovery.type: single-node
      # This setting may need to be set to false to avoid: https://github.com/elastic/elasticsearch/issues/22899
      # Added to support running in emulation on an arm64 (Apple M1) machine on Elasticsearch 6.8.3,
      # Can be removed once we are no longer doing builds requiring 6.8.3
      bootstrap.system_call_filter: ${ELASTICSEARCH_CALL_FILTER:-true}
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"

volumes:
  LocalSettings:
