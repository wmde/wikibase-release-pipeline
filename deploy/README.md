# Wikibase Suite Deployment Kit

Wikibase Suite (WBS) Deployment Kit is a containerised, production ready [Wikibase](https://wikiba.se) system, that allows you to self host a knowledge graph similar to [Wikidata](https://www.wikidata.org/wiki/Wikidata:Main_Page). It orchestrates a set of WBS Service Images using Docker Compose.

> 🔧 This document is for people wanting to self host the full Wikibase Suite using the Wikibase Suite Deployment Kit. If you are looking for individual WBS Service Images, head over to [hub.docker.com/u/wikibase](https://hub.docker.com/u/wikibase).

> 💡 This document assumes basic Linux administration and docker/docker-compose knowledge.

## What is in the box?

WBS Deployment Kit consists of the following services:

- **[Wikibase](https://hub.docker.com/r/wikibase/wikibase)** MediaWiki packaged with the Wikibase extension and other commonly used extensions.
- **Job Runner** The MediaWiki [JobRunner](https://www.mediawiki.org/wiki/Manual:Job_queue#Cron) service which uses the same Wikibase container as above.
- **[MariaDB](https://hub.docker.com/_/mariadb)** Database service for MediaWiki and Wikibase.
- **[Elasticsearch](https://hub.docker.com/r/wikibase/elasticsearch)** Search service used by MediaWiki.
- **[WDQS](https://hub.docker.com/r/wikibase/wdqs)** Wikidata Query Service allowing SPARQL queries.
- **[WDQS Frontend](https://hub.docker.com/r/wikibase/wdqs-frontend)** Web Frontend to run SPARQL queries.
- **[WDQS Proxy](https://hub.docker.com/r/wikibase/wdqs-proxy)** A middle layer for WDQS which serves to filter requests and make the service more secure.
- **[WDQS Updater](https://www.mediawiki.org/wiki/Wikidata_Query_Service/User_Manual#runUpdate.sh)** Keeps the WDQS data in sync with Wikibase.
- **[Quickstatements](https://hub.docker.com/r/wikibase/quickstatements)** A web based tool to import and manipulate large amounts of data.
- **[Traefik](https://hub.docker.com/_/traefik)** A reverse proxy handling TLS termination and ACME certificate renewal.

## Quickstart

> 💡 If you want to run a quick test on a machine that has no public IP address (e.g. your local machine), check our [FAQ item](#can-i-host-wikibase-suite-locally) below.

### Requirements

#### Hardware

- Network connection with a public IP address
- AMD64 architecture
- 8 GB RAM
- 4 GB free disk space

#### Software

- Docker 22.0, or greater
- Docker Compose 2.10, or greater
- git

#### Domain Names

You need three DNS records that resolve to your machine's IP address.

- Wikibase e.g. "wikibase.mydomain.net"
- QueryService e.g. "query.mydomain.net"
- QuickStatements e.g. "quickstatements.mydomain.net"

### Initial Setup

#### Download the WBS Deployment Kit

Checkout the files from Github and move to the subdirectory `deploy`.

```sh
git clone https://github.com/wmde/wikibase-release-pipeline
cd wikibase-release-pipeline/deploy
# TODO update to the correct TAG/BRANCH
git checkout wmde.20
```

#### Initial Configuration

Make a copy of the [configuration template](./template.env) in `wikibase-release-pipeline/deploy`

```sh
cp template.env .env
```

Set usernames, passwords and domain names in your newly created `.env` file
according to the instructions in the comments.

#### Starting

Run the following command from within `wikibase-release-pipeline/deploy`

```sh
docker compose up --wait
```

The first start can take a couple of minutes. Wait for your shell prompt to return.

🎉 Congratulations, your Wikibase Suite instance should be up and running. Web
interfaces are available via HTTPS (port 443) on the domain names you
configured for Wikibase, WDQS Frontend and Quickstatements.

> 💡 If anything goes wrong, check with `docker logs <CONTAINER_NAME>` for helpful error messages.

#### Stopping

To stop, use

```sh
docker compose stop
```

#### Resetting the Configuration

Most values set in `.env` are copied statically into the respective containers
after the first time you run `docker compose up`.

To reset the configuration but keep your existing data:

1. Make any needed changes to the values in the `.env` file copied from
   `template.env` above. NOTE: Do not change `DB_*` values unless you are also
   re-creating the database ([see below](#removing-wikibase-suite-completely-with-all-its-data)).
2. Delete your `LocalSettings.php` from the `./config` directory.
3. Remove and re-create containers with:

```sh
docker compose down
docker compose up --wait
```

### Advanced Configuration
On first launch, WBS Deployment Kit will create files in the `./config` directory next to your `.env` file and the `docker-compose.yml` and `template.env`. This is the configuration of your instance. **You own those files.** Be sure to include them in your backups.

#### `config/LocalSettings.php`
This file is generated by the [MediaWiki installer script](https://www.mediawiki.org/wiki/Manual:Install.php) and augmented by the Wikibase containers `entrypoint.sh` on first launch. Once this file has been generated, you own it. This means you can make changes, you even might [need to make changes on major version updates](https://www.mediawiki.org/wiki/Manual:Upgrading#Adapt_your_LocalSettings.php). In order to ease keeping track of your own adjustments vs settings generated by the Wikibase container, we provide a file called `LocalSettings.override.php`. This file is the preferred location for your adjustments. See below.

The absence of `LocalSettings.php` is the trigger for the Wikibase container to run the [MediaWiki installer script](https://www.mediawiki.org/wiki/Manual:Install.php). If you need to run the installer again, remove the generated `LocalSettings.php` file and restart your instance.

#### `config/LocalSettings.override.php`
This file is the location for your MediaWiki and Wikibase customizations. If you need to regenerate your `LocalSettings.php`, your `LocalSettings.override.php` is the safe place that is never rewritten, even when running the [MediaWiki installer script](https://www.mediawiki.org/wiki/Manual:Install.php).

If you want to, for example, change your site name, just put the following in your `LocalSettings.override.php`.
```php
<?php
$wgSitename = "My New Site Name";
```

Restart your Wikibase container with
```sh
docker restart wikibase-suite-wikibase-1
```

Note that this file is being included after all the other `LocalSettings.php` code, it runs after all extension have been initialized.

#### `config/wikibase-php.ini`
This file is a `php.ini` override file, a good place to tune PHP configuration values. It will be loaded by the Wikibase Webservers PHP interpreter.

#### docker-compose.yml
To further customize your instance, consider adjusting `docker-compose.yml`.

In order to ease updating to newer versions of the WBS Deployment Kit, consider putting your customization into a new file called `docker-compose.override.yml` and from now on, restart your instance with:

```sh
docker compose -f docker-compose.yml -f docker-compose.override.yml down
docker compose -f docker-compose.yml -f docker-compose.override.yml up --wait
```

This way your changes are kept separate from the original WBS Deploying Kit code.

### Managing your data
Besides [your configuration](#configuring-your-wikibase-suite), your data is obviously what makes your instance unique. All data is stored in [Docker Volumes](https://docs.docker.com/storage/volumes/).

 - `wikibase-image-data` MediaWiki image and media file uploads.
 - `mysql-data` MediaWiki/Wikibase MariaDB raw database.
 - `wdqs-data` Wikidata Query Service raw database.
 - `elasticsearch-data` Elastic Search raw database.
 - `quickstatements-data` Generated Quickstatement OAuth binding for this MediaWiki instance.
 - `traefik-letsencrypt-data` SSL certificates.

#### Backup your data
You can backup your data by shutting down the instance and dumping the contents of all Docker Volumes into `.tar.gz` files.

```sh
docker compose down

for v in \
    wikibase-suite-wikibase_image-data \
    wikibase-suite_mysql-data \
    wikibase-suite_wdqs-data \
    wikibase-suite_elasticsearch-data \
    wikibase-suite_quickstatements-data \
    wikibase-suite_traefik-letsencrypt-data; do
  docker run --rm --volume $v:/backup debian:12-slim tar cz backup > $v.tar.gz
done
```

#### Restore from a backup

To restore the volume backups, ensure your instance is shut down with `docker compose down` and populate the Docker Volumes with data from your `.tar.gz` files.

```sh
docker compose down

for v in \
    wikibase-suite-wikibase_image-data \
    wikibase-suite_mysql-data \
    wikibase-suite_wdqs-data \
    wikibase-suite_elasticsearch-data \
    wikibase-suite_quickstatements-data \
    wikibase-suite_traefik-letsencrypt-data; do
  docker volume rm $v 2> /dev/null
  docker volume create $v
  docker run -i --rm --volume $v:/backup debian:12-slim tar xz < $v.tar.gz
done
```

### Updating and Versioning

WBS is versioned with [Semantic Versioning](https://semver.org/spec/v2.0.0.html). The WBS Deployment Kit and all the WBS Service Images have individual version numbers.

WBS Deployment Kit always references the latest minor and patch releases of the compatible WBS Service Images major versions using a special `wbs-dk-MAJOR_VERSION` tag such as `wbs-dk-23` for Wikibase Deployment Kit Versions 23.X.X. This tag is always pointing to the latest compatible version of all the WBS Service Images. For example the `wikibase` Service Image version 3.0.0 might be the initial version released with WBS Deployment Kit 23.0.0. So the `wikibase` Service Image carrying the `v3.0.0` tag will also carry a `wbs-dk-23` tag. When the `wikibase` Service Image version gets bumped to 3.1.0 for a feature release, a new image is released and tagged with `v3.1.0`. The `wbs-dk-23` tag will be reused and will now point to the newly released image 3.1.0. This way, WBS Deployment Kit always references the latest compatible version by always using the same tag. Nothing needs to be updated in WBS Deployment Kit itself. If the `wikibase` Service Image version gets bumped to 4.0.0, this indicates a breaking change. This new image will not receive the `wbs-dk-23` tag, but a new version of WBS Deployment Kit will be released, in this case 24.0.0 and a new tag `wbs-dk-24` will be used to reference compatible images for this version. WBS Deployment Kit can also receive minor and patch updates. But as just described, they are not required to update related WBS Service Images.

#### Minor and patch updates for WBS Service Images

As WBS Deployment Kit always references latest minor and patch releases of compatible WBS Service Images, non breaking changes (including security updates) are applied automatically when recreating Docker containers.

This should be always safe to do. Simply run:

```sh
docker compose down
docker compose up --wait
```

> 💡 If you do not want to pull in new versions of WBS Service Images on container restart, just stop your containers using `docker compose stop` before restart. This will keep the current containers intact. Please note that this will not apply any security updates. It is generally recommended to remove your containers for restart with `docker compose down`.

#### Minor and patch updates for WBS Deployment Kit

WBS Deployment Kit major versions are tracked in dedicated branches such as `TODO:BRANCH_NAME_HERE`. Therefore, pulling from the major version branch you are currently on will only update minor and patch versions but never trigger breaking changes.

Those updates are always considered safe!

If you did not change `docker-compose.yml`, you can update simply using `git pull`.

```sh
# TODO check BRANCH/TAG before release
git pull
```
> 💡 If you have made changes to `docker-compose.yml`, `git commit` them to a separate branch and `git merge` them with upstream changes as you see fit.

> 💡 One major version of WBS Deployment Kit will always reference only one major version for each of the WBS Service Images. Therefore, updating WBS Deployment Kit minor and patch versions from a major versions git branch will never lead to breaking changes in WBS Service Images.

#### Major upgrades

Major version upgrades are performed by updating WBS Deployment Kits major version. This might reference new major versions of WBS Service Images and therefore include breaking changes. Those may require additional steps as described below.

WBS only supports updating from one major version to the next one. If you want to upgrade from 21 to 23, you need to upgrade from 21 to 22 first and then from 22 to 23.


##### Bring down your instance

```sh
docker compose down
```

##### Backup your data and config

[Create a backup](#backup-your-data) of your data.

Backup your `./config` directory too using:
```
cp -r ./config ./config-$(date +%Y%M%d%H%M%S)
```

> 💡 If you have made changes to `docker-compose.yml`, `git commit` them to a separate branch and `git merge` them as you see fit in the next step.

##### Pull new version

WBS Deployment Kit major versions are tracked in separate branches. Switch your checkout to the new major version branch.

```sh
git remote update
git checkout TODO:NEW_BRANCH_NAME_HERE
git pull
```

> 💡 If you have made changes to `docker-compose.yml`, `git merge` them as you see fit.

##### Apply changes to .env (if any)

Look for changes in the new `template.env` that you might want to apply to your `.env` file.

##### Apply migrations according to your version (if any)

<details><summary><strong>WBS Deployment Kit 23 to 24 (MediaWiki 1.41 to MediaWiki 1.42)</strong></summary><p>

Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_42/UPGRADE).

Besides that, no further migrations are necessary.

</p></details>

<details><summary><strong>WBS Deployment Kit 22 to 23 (MediaWiki 1.40 to MediaWiki 1.41)</strong></summary><p>

Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_41/UPGRADE).

Besides that, no further migrations are necessary.

</p></details>

<details><summary><strong>WBS Deployment Kit 21 to 22 (MediaWiki 1.39 to MediaWiki 1.40)</strong></summary><p>

Checkout the [MediaWiki UPGRADE file](https://gerrit.wikimedia.org/r/plugins/gitiles/mediawiki/core/+/refs/heads/REL1_40/UPGRADE).

Besides that, no further migrations are necessary.

</p></details>


##### Bring your instance back up

```
docker compose up --wait
```

#### Automatic updates

At the moment, WBS Deployment Kit does not support automatic updates. To automatically deploy minor and patch updates including security fixes to your WBS Service Images, [restart your instance](#minor-and-patch-updates-for-wbs-service-containers) on a regular basis, e.g. with a systemd timer or cron job.

#### Downgrades
Downgrades are not supported. In order to revert an update, restore your data from a backup made prior to the upgrade.

### Removing Wikibase Suite Completely with all its Data

‼️ **This will destroy all data, make sure to [backup anything](#backup-your-data) you wish to retain.**

To reset the configuration and data, remove the Docker Containers, Docker Volumes and the generated `LocalSettings.php` file.

```sh
docker compose down --volumes
rm config/LocalSettings.php
```

Removing the `traefik-letsencrypt-data` volume will request a new certificate from LetsEncrypt on the next launch of your instance. Certificate generation on LetsEncrypt is [rate limited](https://letsencrypt.org/docs/rate-limits/). Eventually, you might be blocked from generating new certificates **for a couple of days**. To prevent that, switch to the LetsEncrypt staging server by appending the following to your `traefik` `command` in  your `docker-compose.yml` file:
```yml
--certificatesresolvers.letsencrypt.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory
```
## FAQ

### Can I host Wikibase Suite locally?

Yes, Wikibase Suite can be hosted locally for testing purposes by using e.g. the example domain names `*.mydomain.net` from `template.env` in your `.env` file. Configure those domain names also in your `/etc/hosts` to make them resolve to `127.0.0.1`.

However, due to OAuth requirements, QuickStatements may not function properly without a publicly accessible domain names for both the `WIKIBASE_PUBLIC_HOST` and `QUICKSTATEMENTS_PUBLIC_HOST`. Running locally without publicly accessible addresses will also not generate a valid SSL certificate so accessing services will require allowing the invalid certificate on first load in the browser.

### Can I migrate from another Wikibase installation to WBS Deployment Kit?

It is possible to migrate an existing Wikibase installation to WBS Deployment Kit. The general procedure is:

 - [Backup your MediaWiki](https://www.mediawiki.org/wiki/Manual:Backing_up_a_wiki)
 - Install Wikibase Suite as [described above](#initial-setup)
 - Re-apply [customization](#customizing-your-wikibase-suite-mediawiki) to `config/LocalSettings.override.php`
 - Import your database dump
 - Regenerate WDQS database
 - Regenerate elasticsearch database

### Do you have any recommended Internet host / VPS provider recommendations?

At this time, there are no specific recommendations for Internet hosts or VPS providers for hosting Wikibase Suite. The suite has been tested on various providers, and as long as the [minimum technical requirements](#hardware) are met, it should run as expected.

The provided files are for configuring and deploying Wikibase Suite using Docker containers. Wikibase is an extension for MediaWiki that enables the creation and management of structured data, similar to Wikidata. In addition to this configuration of MediaWiki, Wikibase suite includes the Wikidata Query Service (WDQS), QuickStatements, Elasticsearch, and a reverse proxy with SSL services. The configuration is managed through Docker Compose and environment variables.

### Where can I get further help?

Feel free to join the [Wikibase Telegram channel](https://t.me/+WBsf9-C9KPuMZCDT) if you have any questions.
