#!/usr/bin/env bash
set -e

echo "ðŸ”§ Wikibase Deploy CLI Installer"

# --- Parse args passed from go.sh ---
for arg in "$@"; do
  case $arg in
    --verbose=*) VERBOSE="${arg#*=}" ;;
    --deploy-dir=*) DEPLOY_DIR="${arg#*=}" ;;
    --log-path=*) LOG_PATH="${arg#*=}" ;;
    --local=*) LOCALHOST="${arg#*=}" ;;
  esac
done

# -- Setup logging -- 
# shellcheck disable=SC1091
source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/_logging.sh"

ENV_FILE_PATH="$DEPLOY_DIR/.env"
PUBLIC_IP=$(curl --silent --show-error --fail https://api.ipify.org)

read -rp "Admin Email Address: " MW_ADMIN_EMAIL

read -rp "Wikibase Public Host (default: $PUBLIC_IP.nip.io): " WIKIBASE_PUBLIC_HOST
WIKIBASE_PUBLIC_HOST=${WIKIBASE_PUBLIC_HOST:-$PUBLIC_IP.nip.io}

read -rp "Query Service Host [query.$WIKIBASE_PUBLIC_HOST]: " WDQS_PUBLIC_HOST
WDQS_PUBLIC_HOST=${WDQS_PUBLIC_HOST:-query.$WIKIBASE_PUBLIC_HOST}

read -rp "MediaWiki Admin Username [Admin]: " MW_ADMIN_NAME
MW_ADMIN_NAME=${MW_ADMIN_NAME:-Admin}

# Admin Password
while true; do
  read -rsp "MediaWiki Admin Password (leave blank for autogenerated): " MW_ADMIN_PASS
  echo
  if [ -z "$MW_ADMIN_PASS" ]; then
    MW_ADMIN_PASS=$(openssl rand -base64 8 | tr -dc 'a-zA-Z0-9' | cut -c1-10)
    break
  elif [ ${#MW_ADMIN_PASS} -lt 10 ]; then
    echo "âŒ Password must be at least 10 characters. Try again."
  else
    break
  fi
done

# Database Password
while true; do
  read -rsp "Database Password (leave blank for autogenerated): " DB_PASS
  echo
  if [ -z "$DB_PASS" ]; then
    DB_PASS=$(openssl rand -base64 8 | tr -dc 'a-zA-Z0-9' | cut -c1-10)
    break
  elif [ ${#DB_PASS} -lt 10 ]; then
    echo "âŒ Password must be at least 10 characters. Try again."
  else
    break
  fi
done

read -rp "Database Name [my_wiki]: " DB_NAME
DB_NAME=${DB_NAME:-my_wiki}

read -rp "Database User [sqluser]: " DB_USER
DB_USER=${DB_USER:-sqluser}

read -rp "Expose this Wikibase to global directory? (y/n) [y]: " METADATA_CALLBACK
METADATA_CALLBACK=${METADATA_CALLBACK,,}  # lowercase
test "$METADATA_CALLBACK" != "n" && METADATA_CALLBACK=true || METADATA_CALLBACK=false

mkdir -p "$(dirname "$ENV_FILE_PATH")"

cat > "$ENV_FILE_PATH" <<EOF
# Autogenerated .env from CLI installer
MW_ADMIN_EMAIL=$MW_ADMIN_EMAIL
WIKIBASE_PUBLIC_HOST=$WIKIBASE_PUBLIC_HOST
WDQS_PUBLIC_HOST=$WDQS_PUBLIC_HOST
MW_ADMIN_PASS=$MW_ADMIN_PASS
DB_PASS=$DB_PASS
MW_ADMIN_NAME=$MW_ADMIN_NAME
DB_NAME=$DB_NAME
DB_USER=$DB_USER
METADATA_CALLBACK=$METADATA_CALLBACK
EOF

echo
cat "$ENV_FILE_PATH"
echo

echo "âœ… Configuration saved."
